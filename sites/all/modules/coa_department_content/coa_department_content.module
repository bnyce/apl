<?php

/** HARD CODED MODULE GLOBALS
 * These are the various taxonomies and their vocab id.
 */
    global $DEPT_TAX;
    global $DEBUGGING2;
    
    $DEBUGGING2 = TRUE;
    $DEPT_TAX = array('vid' => 15, 'machine_name' => 'department', 'name' => '== Departments ==');

/**
* Implementation of hook_permission()
* Adds permission to edit Department Home Page restrictions
*/
function coa_department_content_permission() {
    return array(
			'modify department restrictions' => array( 
                'title'       => t('Modify Department Page Restrictions'),
				'description' => t('Allow user to view and modify Department Home Page content restrictions'),
             )
     );
}


/**
* Implementation of hook_form_alter().	
* This modifies the default edit form of each moderated content type.
* A new case will need to be created for each content type that will be located by the primary site taxonomies.
*/
function coa_department_content_form_alter(&$form, $form_state, $form_id) {
   global $DEBUGGING2;
   // a switch is used because you may want to alter more than
   // one form and it is easy to add a new case for each form.
   switch ($form_id) {
     // This is our form ID.
     case 'department_node_form':
     	  // If user doesn't have permission to modify verification restrictions hide the block.
     	  if (!user_access('modify department restrictions')) {
     	    $form['field_dept_chars']['#type']    = 'hidden';
     	    $form['field_dept_features']['#type'] = 'hidden';
     	  };
		  
		  /*
		  
		  $form['workbench_access']['workbench_access_id']['#ajax'] = array(
		                            // 'callback' is a function that will be called when this element changes.
      								'callback' => 'coa_department_content_update_title_callback',
		                             // 'wrapper' is the HTML id of the page element that will be replaced.
      								'wrapper' => 'replace_title_div',
		                            'method' => 'fade',
		                          );
		   
		  $form['title']         = array(
    								'#type' => 'textfield',
    								'#title' => t("Department or Program Name!"),
		                            '#required' => TRUE,
		                            '#maxlength' => 255,
		                            '#weight' => -5,
		                            '#default_value' => isset($form_state['values']['title']) ? $form_state['values']['title'] : '',                          
		                            // The prefix/suffix provide the div that we're replacing, named by
		                            // #ajax['wrapper'] above.
    								'#prefix' => '<div id="replace_title_div">',
    								'#suffix' => '</div>',
		                          );	
			*/
		  $form['#validate'][] = '_coa_department_content_validate';
		  //$form['#submit'][] = 'coa_department_content_node_form_submit';
		  //$form['actions']['submit']['#submit'][] = 'coa_department_content_node_form_submit';
		  
		  if($DEBUGGING2) dpm($form, "form");
		  //dpm($form, "form");		   
      break; 
    };
};

/**
 * 
 */
function coa_department_content_update_title_callback($form, $form_state){
		  // An AJAX request calls the form builder function for every change.
		  // We can change how we build the form based on $form_state.
		  if (!empty($form_state['values']['workbench_access_id'])) {
		      $value = $form_state['values']['workbench_access_id'][0];
		      $form['title']         = array(
    								'#type' => 'textfield',
    								'#title' => t("Department or Program Name!!"),
		                            '#required' => TRUE,
		                            '#maxlength' => 255,
		                            '#weight' => -5,
		                            '#default_value' => 'SAMPLE',
		                            
		                            // The prefix/suffix provide the div that we're replacing, named by
		                            // #ajax['wrapper'] above.
    								'#prefix' => '<div id="replace_title_div">',
    								'#suffix' => '</div>',
		                          );	 
		        //$form['title']['#default_value'] = $form_state['values']['workbench_access_id'][0];
		        dpm($value, 'value');
		  }        
}
  
/**
* Validate the node edit form.
*/
function _coa_department_content_validate($form, &$form_state) {
    
    //get the number of characters
    $num_char = 6;
    $num_char2 = 8;
    
    //$num_char = strlen($form_state['values']['body']['en']);
    //$num_char2 = strlen($form_state['values']['field_dept_message']['en'][0]);
    $message = t("Body =  and Message 0 = ");
  	form_set_error('body', $message);
   	/*	
      foreach ($sections as $section => $key) {
          $term        = taxonomy_term_load($section);    
  	    if (empty($term)) {
  	      $message = t("You have selected a top-level Section Heading. Please be more specific in selecting an Editorial Section.");
  	      form_set_error('workbench_access_id', $message);
   	      };
      };
	};
	*/
};

/**
* Additional handler for page node form submit.
*/
function coa_department_content_node_form_submit($form, &$form_state) {
  //$form_id = $form->#form_id;
  $form_id = $form['#form_id'];
  
    if($DEBUGGING2)  dpm($form_state['values'], 'form_state');
}

